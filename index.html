map.on('load', async () => {
  map.addSource('koppen', { type: 'geojson', data: './koppen.json' });
  map.addLayer({
    id: 'koppen-layer',
    type: 'fill',
    source: 'koppen',
    paint: { 'fill-color': ['get', 'fill'], 'fill-opacity': 0.5 }
  });

  map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'top-right');
  const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    mapboxgl,
    marker: false,
    placeholder: 'Search for a place'
  });
  map.addControl(geocoder, 'top-left');

  // --- Load pins (will only work from HTTP server, not file://) ---
  const res = await fetch('pins.json');
  const points = await res.json();
  points.forEach(pt => {
    const coords = [pt.longitude, pt.latitude];
    const bright = brightnessFromHex(pt.zones?.[0]?.colour) >= BRIGHTNESS_THRESHOLD;
    const cls = bright ? 'zone-text stroke' : 'zone-text';
    const zone = `<span class="${cls}" style="color:${pt.zones?.[0]?.colour};">${pt.zones?.[0]?.text}</span>`;
    const popup = `
      <a href="${pt.link}" target="_blank" rel="noopener noreferrer">
        <div style="font-weight:700;text-align:center;font-size:17px;margin-bottom:4px;">${pt.title}</div>
        ${pt.address||''}<br>${zone}<br>
        ${pt.gdpr?'<em>Marked area not exact.</em><br>':''}
        ${pt.imageUrl?`<div style="text-align:center;"><img class="popup-image" src="${pt.imageUrl}"></div>`:''}
      </a>`;
    new mapboxgl.Marker({ color: '#FCF5E3' })
      .setLngLat(coords)
      .setPopup(new mapboxgl.Popup().setHTML(popup))
      .addTo(map);
    if (pt.gdpr) {
      const id = `circle-${pt.id}`;
      const circle = createGeoJSONCircle(coords, pt.radiusKm);
      map.addSource(id, { type: 'geojson', data: circle });
      map.addLayer({ id: `${id}-fill`, type: 'fill', source: id, paint: { 'fill-color': '#fff', 'fill-opacity': 0.15 } });
      map.addLayer({ id: `${id}-line`, type: 'line', source: id, paint: { 'line-color': '#fff', 'line-width': 1 } });
    }
  });

  // --- Delay a moment to ensure style layers (labels) exist ---
  map.once('idle', () => {
    const labelIds = map.getStyle().layers
      .filter(l => l.type === 'symbol' && l.layout?.['text-field'])
      .map(l => l.id);
    const slider = document.getElementById('opacitySlider');
    const setOpacity = v => {
      const val = parseFloat(v);
      if (map.getLayer('koppen-layer'))
        map.setPaintProperty('koppen-layer', 'fill-opacity', val);
      labelIds.forEach(id => {
        if (map.getLayer(id))
          map.setPaintProperty(id, 'symbol-opacity', val);
      });
    };
    slider.addEventListener('input', e => setOpacity(e.target.value));
    setOpacity(slider.value);
  });
});
