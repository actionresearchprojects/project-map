<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KÃ¶ppen-Geiger Globe - Mapbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">
  <style>
    /* your existing styles, unmodified */
  </style>
</head>
<body>
<div id="map"></div>

<div id="controlWrapper">
  <!-- controls unchanged -->
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiYXJjaHdydGgiLCJhIjoiY21hZHZpb3Y0MDB3czJxcjZxNjMyNjV5ayJ9.Z5pVSBUcI3HDeALtF6YIiA';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/satellite-v9',
    projection: 'globe',
    zoom: 1.5,
    center: [39.271406, -7.046950],
    pitch: 0,
    bearing: 0
  });

  map.on('style.load', () => map.setFog({}));

  map.on('load', () => {
    // climate layer unchanged

    // load point data
    fetch('pins.json')
      .then(res => res.json())
      .then(points => {
        points.forEach(pt => {
          // apply masking if needed
          const coords = pt.gdpr
            ? generateMaskedCoords(pt.latitude, pt.longitude, pt.radiusKm)
            : [pt.longitude, pt.latitude];

          // marker + popup
          new mapboxgl.Marker({ color: pt.colour })
            .setLngLat(coords)
            .setPopup(new mapboxgl.Popup().setHTML(
              `<a href="${pt.link}" target="_blank" rel="noopener noreferrer" style="text-decoration:none;color:inherit;font-family:'Ubuntu',sans-serif;">
                <strong>${pt.title}</strong><br>
                ${pt.address}<br>
                <span style="color:${pt.zoneColour};">${pt.zoneText}</span><br>
                ${pt.gdpr ? '<em>Marked area is not exact.</em><br>' : ''}
                <img class="popup-image" src="${pt.imageUrl}" alt="${pt.title}" />
              </a>`
            ))
            .addTo(map);

          // optional circle
          if (pt.gdpr) {
            const circleGeoJSON = createGeoJSONCircle(coords, pt.radiusKm);
            const srcId = `circle-${pt.id}`;
            map.addSource(srcId, { type: 'geojson', data: circleGeoJSON });
            map.addLayer({
              id: `${srcId}-fill`,
              type: 'fill',
              source: srcId,
              paint: { 'fill-color': pt.colour, 'fill-opacity': 0.15 }
            });
            map.addLayer({
              id: `${srcId}-line`,
              type: 'line',
              source: srcId,
              paint: { 'line-color': pt.colour, 'line-width': 1 }
            });
          }
        });
      });

    // navigation control
    map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'top-right');
  });

  // include your existing helper functions:
  // createGeoJSONCircle(), generateMaskedCoords(), toggle handlers, etc.
</script>
</body>
</html>
